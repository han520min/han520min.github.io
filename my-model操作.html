<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>韩敏的技术博客</title>
	<meta name="description" content="">
	<meta name="author" content="韩敏">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="/theme/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/local.css" rel="stylesheet">
	<link href="/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->




</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="/">韩敏的技术博客</a>
			<ul class="nav">
					<li ><a href="/category/celery.html">celery</a></li>
					<li ><a href="/category/devops.html">DevOps</a></li>
					<li ><a href="/category/django.html">Django</a></li>
					<li ><a href="/category/git.html">GIT</a></li>
					<li ><a href="/category/ji-zhu.html">技术</a></li>
					<li ><a href="/category/jwt.html">jwt</a></li>
					<li ><a href="/category/linux.html">Linux</a></li>
					<li class="active"><a href="/category/modelcao-zuo.html">model操作</a></li>
					<li ><a href="/category/myself.html">myself</a></li>
					<li ><a href="/category/rabbitmq.html">rabbitmq</a></li>
					<li ><a href="/category/redis.html">redis</a></li>
					<li ><a href="/category/supervisor.html">Supervisor</a></li>
					<li ><a href="/category/vue.html">VUE</a></li>
					<li ><a href="/category/yun-wei.html">运维</a></li>
			</ul>
			<p class="pull-right"><a href="/archives.html">[archives]</a> <a href="/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<h3>Blogroll</h3>
			<ul>
				<li><a href="http://getpelican.com/">Pelican</a></li>
				<li><a href="http://python.org/">Python.org</a></li>
				<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="https://shangxiaoweia.github.io">shangwei</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>model操作</h1></div>
		<div class="well small">Permalink: <a class="more" href="/my-model操作.html">2019-12-19 18:44:00+01:00</a>
by <a class="url fn" href="/author/han-min.html">韩敏 </a>
 in <a href="/category/modelcao-zuo.html">model操作</a>
tags: <a href="/tag/django.html">Django</a> </div>
		<div><h3>1.1 Django中使用MySQL</h3>
<p><strong>1、先写类：在 app01/models.py中写类</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>         <span class="c1"># 自增id</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>


<p><strong>2、在Django项目中使用MySQL</strong></p>
<p><strong>1. 创建管理员密码,与数据库</strong></p>
<p>1.  mysqladmin -uroot password 123456                 #  用户名：root         密码：123456</p>
<p>2.   mysql -uroot -p                                               #  dos下登录MySQL</p>
<p>3.  <strong>create database MyCRM charset utf8;</strong>                #  创建数据库MyCRM</p>
<p>4.  drop database MyCRM;                                    # 如果需要也可以把数据库删除</p>
<p>5.  show databases;                                             #  查看现有数据库</p>
<p><strong>2. 配置使用MySQL（修改settings.py配置文件）</strong></p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;MyCRM&#39;</span><span class="p">,</span>              <span class="c1"># 指定数据库名称：MyCRM</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;123456&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;3306&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="sd">&#39;&#39;&#39;注释默认数据库配置&#39;&#39;&#39;</span>
<span class="c1"># DATABASES = {</span>
<span class="c1">#     &#39;default&#39;: {</span>
<span class="c1">#         &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,</span>
<span class="c1">#         &#39;NAME&#39;: os.path.join(BASE_DIR, &#39;db.sqlite3&#39;),</span>
<span class="c1">#     }</span>
<span class="c1"># }</span>
</pre></div>


<p><strong>3. 主动修改为pymysql</strong></p>
<p>1. Django默认使用MySQLdb模块链接MySQL，但在python3中还没有MySQLdb</p>
<p>2. 主动修改为pymysql，在project同名文件夹下的__init__文件中添加如下代码即可</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymysql</span>
<span class="n">pymysql</span><span class="o">.</span><span class="n">install_as_MySQLdb</span><span class="p">()</span>
</pre></div>


<p>​       <strong>4. 创建表  （记得注册APP）</strong></p>
<p><strong>python manage.py makemigrations</strong>
　　　　　　　　<strong>python manage.py migrate --fake</strong></p>
<p><strong>5. 远程链接MySQL报错问题解决</strong></p>
<div class="highlight"><pre><span></span><span class="err">授权法</span>
<span class="c1">#1、例如，你想myuser使用mypassword从任何主机连接到mysql服务器的话。</span>
<span class="c1"># GRANT ALL PRIVILEGES ON *.* TO &#39;myuser&#39;@&#39;%&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION;</span>
<span class="c1"># FLUSH   PRIVILEGES;</span>


<span class="c1">#2、如果你想允许用户myuser从ip为192.168.1.6的主机连接到mysql服务器，并使用mypassword作为密码</span>
<span class="c1"># GRANT ALL PRIVILEGES ON *.* TO &#39;myuser&#39;@&#39;192.168.1.3&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION;</span>
<span class="c1"># FLUSH   PRIVILEGES;</span>


<span class="c1">#3、如果你想允许用户myuser从ip为192.168.1.6的主机连接到mysql服务器的dk数据库，并使用mypassword作为密码</span>
<span class="c1"># GRANT ALL PRIVILEGES ON dk.* TO &#39;myuser&#39;@&#39;192.168.1.3&#39; IDENTIFIED BY &#39;mypassword&#39; WITH GRANT OPTION;</span>
<span class="c1"># FLUSH   PRIVILEGES;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">改表法</span>
<span class="c1"># mysql -u root -pvmwaremysql&gt;use mysql;</span>

<span class="c1"># mysql&gt;update user set host = &#39;%&#39; where user = &#39;root&#39;;</span>

<span class="c1"># mysql&gt;select host, user from user;</span>
</pre></div>


<h3>1.2 创建表</h3>
<p><strong>1、创建表基本语法</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>         <span class="c1"># 自增id</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>


<p><strong>2、元信息Meta</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="c1">#1 数据库中生成的表名称 默认 app名称 + 下划线 + 类名</span>
            <span class="n">db_table</span> <span class="o">=</span> <span class="s2">&quot;table_name&quot;</span>     <span class="c1">#自己指定创建的表名</span>

            <span class="c1">#2 Django Admin 中显示的表名称</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;user&#39;</span>          <span class="c1">#在Django admin后台显示时表名是users</span>

            <span class="c1">#3 verbose_name加s</span>
            <span class="n">verbose_name_plural</span><span class="o">=</span><span class="s1">&#39;user&#39;</span>  <span class="c1">#若果这个字段也是user那么4中表名才显示user</span>

            <span class="c1">#4 联合唯一索引</span>
            <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">),)</span>

            <span class="c1">#5 联合索引   (缺点是最左前缀，写SQL语句基于password时不能命中索引，查找慢)</span>
            <span class="c1">#  如：select * from tb where password = ‘xx’    就无法命中索引</span>
            <span class="n">index_together</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">),</span>
            <span class="p">]</span>
<span class="c1"># 更多：https://docs.djangoproject.com/en/1.10/ref/models/options/</span>
</pre></div>


<p><strong>3、字段</strong></p>
<div class="highlight"><pre><span></span><span class="c1">#常用字段</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">UserGroup</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="n">ctime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>      <span class="c1"># 只有添加时才会更新时间</span>
    <span class="n">uptime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>         <span class="c1"># 只要修改就会更新时间</span>

    <span class="n">ip1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IPAddressField</span><span class="p">()</span>                  <span class="c1"># 字符串类型，Django Admin以及ModelForm中提供验证 IPV4 机制</span>
    <span class="n">ip2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GenericIPAddressField</span><span class="p">()</span>           <span class="c1"># 字符串类型，Django Admin以及ModelForm中提供验证 Ipv4和Ipv6</span>

    <span class="n">active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">data01</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>                      <span class="c1"># 日期+时间格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ</span>
    <span class="n">data02</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>                          <span class="c1"># 日期格式      YYYY-MM-DD</span>
    <span class="n">data03</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TimeField</span><span class="p">()</span>                          <span class="c1"># 时间格式      HH:MM[:ss[.uuuuuu]]</span>

    <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>           <span class="c1"># 正小整数 0 ～ 32767</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">()</span>          <span class="c1"># 小整数 -32768 ～ 32767</span>
    <span class="n">money</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>         <span class="c1"># 正整数 0 ～ 2147483647</span>
    <span class="n">bignum</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BigIntegerField</span><span class="p">()</span>             <span class="c1"># 长整型(有符号的) -9223372036854775808 ～ 9223372036854775807</span>

    <span class="n">user_type_choices</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;超级用户&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;普通用户&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;普普通用户&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">user_type_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">user_type_choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span> <span class="c1">#不常用字段</span>
    <span class="n">URLField</span><span class="p">(</span><span class="n">CharField</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串类型，</span><span class="n">Django</span> <span class="n">Admin以及ModelForm中提供验证</span> <span class="n">URL</span>

    <span class="n">SlugField</span><span class="p">(</span><span class="n">CharField</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串类型，</span><span class="n">Django</span> <span class="n">Admin以及ModelForm中提供验证支持</span> <span class="err">字母、数字、下划线、连接符（减号）</span>

    <span class="n">CommaSeparatedIntegerField</span><span class="p">(</span><span class="n">CharField</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串类型，格式必须为逗号分割的数字</span>

    <span class="n">UUIDField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串类型，</span><span class="n">Django</span> <span class="n">Admin以及ModelForm中提供对UUID格式的验证</span>

    <span class="n">FilePathField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串，</span><span class="n">Django</span> <span class="n">Admin以及ModelForm中提供读取文件夹下文件的功能</span>
        <span class="o">-</span> <span class="err">参数：</span>
                <span class="n">path</span><span class="p">,</span>                      <span class="err">文件夹路径</span>
                <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                <span class="err">正则匹配</span>
                <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>           <span class="err">递归下面的文件夹</span>
                <span class="n">allow_files</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>          <span class="err">允许文件</span>
                <span class="n">allow_folders</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>       <span class="err">允许文件夹</span>

    <span class="n">FileField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串，路径保存在数据库，文件上传到指定目录</span>
        <span class="o">-</span> <span class="err">参数：</span>
            <span class="n">upload_to</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>      <span class="err">上传文件的保存路径</span>
            <span class="n">storage</span> <span class="o">=</span> <span class="bp">None</span>      <span class="err">存储组件，默认</span><span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FileSystemStorage</span>

    <span class="n">ImageField</span><span class="p">(</span><span class="n">FileField</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">字符串，路径保存在数据库，文件上传到指定目录</span>
        <span class="o">-</span> <span class="err">参数：</span>
            <span class="n">upload_to</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>      <span class="err">上传文件的保存路径</span>
            <span class="n">storage</span> <span class="o">=</span> <span class="bp">None</span>      <span class="err">存储组件，默认</span><span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FileSystemStorage</span>
            <span class="n">width_field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>   <span class="err">上传图片的高度保存的数据库字段名（字符串）</span>
            <span class="n">height_field</span><span class="o">=</span><span class="bp">None</span>   <span class="err">上传图片的宽度保存的数据库字段名（字符串）</span>


    <span class="n">DurationField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">长整数，时间间隔，数据库中按照</span><span class="n">bigint存储</span><span class="err">，</span><span class="n">ORM中获取的值为datetime</span><span class="o">.</span><span class="n">timedelta类型</span>

    <span class="n">FloatField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">浮点型</span>

    <span class="n">DecimalField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="mi">10</span><span class="err">进制小数</span>
        <span class="o">-</span> <span class="err">参数：</span>
            <span class="n">max_digits</span><span class="err">，小数总长度</span>
            <span class="n">decimal_places</span><span class="err">，小数位长度</span>

    <span class="n">BinaryField</span><span class="p">(</span><span class="n">Field</span><span class="p">)</span>
        <span class="o">-</span> <span class="err">二进制类型</span>
</pre></div>


<h3>1.3一大波Model操作</h3>
<div class="highlight"><pre><span></span><span class="c1">#基本操作</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">def</span> <span class="nf">orm</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># 1 创建</span>
    <span class="c1"># 创建数据方法一</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
    <span class="c1"># 创建数据方法二</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;alex&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># 创建数据库方法三(传入字典必须在字典前加两个星号)</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;eric&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;666&#39;</span><span class="p">}</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">dic</span><span class="p">)</span>

    <span class="c1"># 2 查</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># 查找所有条目</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;alex&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># 3 删除</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># 删除所有</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>  <span class="c1"># 删除指定</span>

    <span class="c1"># 4 更新</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;15&#39;</span><span class="p">)</span>

    <span class="c1"># 5 获取个数</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;seven&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># 6 执行原生SQL</span>
    <span class="c1"># 6.1 执行原生SQL</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;select * from userinfo&#39;</span><span class="p">)</span>

    <span class="c1"># 6.2 如果SQL是其他表时，必须将名字设置为当前UserInfo对象的主键列名</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;select id as nid from 其他表&#39;</span><span class="p">)</span>

    <span class="c1"># 6.3 指定数据库</span>
    <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;select * from userinfo&#39;</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;orm&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">#进阶操作</span>
<span class="mi">1</span><span class="err">、大于，小于</span>
        <span class="c1"># models.Tb1.objects.filter(id__gt=1)                 # 获取id大于1的值</span>
        <span class="c1"># models.Tb1.objects.filter(id__gte=1)                # 获取id大于等于1的值</span>
        <span class="c1"># models.Tb1.objects.filter(id__lt=10)                # 获取id小于10的值</span>
        <span class="c1"># models.Tb1.objects.filter(id__lte=10)               # 获取id小于10的值</span>
        <span class="c1"># models.Tb1.objects.filter(id__lt=10, id__gt=1)      # 获取id大于1 且 小于10的值</span>
<span class="mi">2</span><span class="err">、</span><span class="ow">in</span>
        <span class="c1"># models.Tb1.objects.filter(id__in=[11, 22, 33])      # 获取id等于11、22、33的数据</span>
        <span class="c1"># models.Tb1.objects.exclude(id__in=[11, 22, 33])     # not in</span>
<span class="mi">3</span><span class="err">、</span><span class="n">isnull</span>
        <span class="c1"># Entry.objects.filter(pub_date__isnull=True)         #双下划线isnull，查找pub_date是null的数据</span>
<span class="mi">4</span><span class="err">、</span><span class="n">contains</span>                                                    <span class="c1">#就是原生sql的like操作:模糊匹配</span>
        <span class="c1"># models.Tb1.objects.filter(name__contains=&quot;ven&quot;)</span>
        <span class="c1"># models.Tb1.objects.filter(name__icontains=&quot;ven&quot;)    # icontains大小写不敏感</span>
        <span class="c1"># models.Tb1.objects.exclude(name__icontains=&quot;ven&quot;)</span>
<span class="mi">5</span><span class="err">、</span><span class="nb">range</span>
       <span class="c1"># models.Tb1.objects.filter(id__range=[1, 2])          # 范围bettwen and</span>
<span class="mi">6</span><span class="err">、</span><span class="n">order</span> <span class="n">by</span>
        <span class="c1"># models.Tb1.objects.filter(name=&#39;seven&#39;).order_by(&#39;id&#39;)      # asc     没有减号升续排列</span>
        <span class="c1"># models.Tb1.objects.filter(name=&#39;seven&#39;).order_by(&#39;-id&#39;)     # desc      有减号升续排列</span>
<span class="mi">7</span><span class="err">、</span><span class="n">group</span> <span class="n">by</span>
        <span class="c1"># from django.db.models import Count, Min, Max, Sum</span>
        <span class="c1"># models.Tb1.objects.filter(c1=1).values(&#39;id&#39;).annotate(c=Count(&#39;num&#39;))        #根据id列进行分组</span>
        <span class="c1"># SELECT &quot;app01_tb1&quot;.&quot;id&quot;, COUNT(&quot;app01_tb1&quot;.&quot;num&quot;) AS &quot;c&quot; FROM &quot;app01_tb1&quot; </span>
        <span class="c1"># WHERE &quot;app01_tb1&quot;.&quot;c1&quot; = 1 GROUP BY &quot;app01_tb1&quot;.&quot;id&quot;</span>
<span class="mi">8</span><span class="err">、</span><span class="n">limit</span> <span class="err">、</span><span class="n">offset</span>    <span class="c1">#分页</span>
        <span class="c1"># models.Tb1.objects.all()[10:20]</span>
<span class="mi">9</span><span class="err">、</span><span class="n">regex正则匹配</span><span class="err">，</span><span class="n">iregex</span> <span class="err">不区分大小写</span>
        <span class="c1"># Entry.objects.get(title__regex=r&#39;^(An?|The) +&#39;)</span>
        <span class="c1"># Entry.objects.get(title__iregex=r&#39;^(an?|the) +&#39;)</span>


<span class="mi">10</span><span class="err">、</span><span class="n">date</span>
        <span class="c1"># Entry.objects.filter(pub_date__date=datetime.date(2005, 1, 1))          #__data表示日期查找，2005-01-01</span>
        <span class="c1"># Entry.objects.filter(pub_date__date__gt=datetime.date(2005, 1, 1))</span>
<span class="mi">11</span><span class="err">、</span><span class="n">year</span>
        <span class="c1"># Entry.objects.filter(pub_date__year=2005)                               #__year根据年查找</span>
        <span class="c1"># Entry.objects.filter(pub_date__year__gte=2005)</span>
<span class="mi">12</span><span class="err">、</span><span class="n">month</span>
        <span class="c1"># Entry.objects.filter(pub_date__month=12)</span>
        <span class="c1"># Entry.objects.filter(pub_date__month__gte=6)</span>
<span class="mi">13</span><span class="err">、</span><span class="n">day</span>
        <span class="c1"># Entry.objects.filter(pub_date__day=3)</span>
        <span class="c1"># Entry.objects.filter(pub_date__day__gte=3)</span>
<span class="mi">14</span><span class="err">、</span><span class="n">week_day</span>
        <span class="c1"># Entry.objects.filter(pub_date__week_day=2)</span>
        <span class="c1"># Entry.objects.filter(pub_date__week_day__gte=2)</span>
<span class="mi">15</span><span class="err">、</span><span class="n">hour</span>
        <span class="c1"># Event.objects.filter(timestamp__hour=23)</span>
        <span class="c1"># Event.objects.filter(time__hour=5)</span>
        <span class="c1"># Event.objects.filter(timestamp__hour__gte=12)</span>
<span class="mi">16</span><span class="err">、</span><span class="n">minute</span>
        <span class="c1"># Event.objects.filter(timestamp__minute=29)</span>
        <span class="c1"># Event.objects.filter(time__minute=46)</span>
        <span class="c1"># Event.objects.filter(timestamp__minute__gte=29)</span>
<span class="mi">17</span><span class="err">、</span><span class="n">second</span>
        <span class="c1"># Event.objects.filter(timestamp__second=31)</span>
        <span class="c1"># Event.objects.filter(time__second=2)</span>
        <span class="c1"># Event.objects.filter(timestamp__second__gte=31)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">#根据天/小时操作过滤</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">report.models</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="c1"># start_time = now - timezone.timedelta(days=7)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timezone</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">240</span><span class="p">)</span>  <span class="c1"># 查询10天前的数据</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">now</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">AllClarm</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">start_tm__range</span><span class="o">=</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1">#get_objects_or_404获取或返回404页面</span>
<span class="c1">#! /usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span>

<span class="k">class</span> <span class="nc">SLAGroup</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;组名&#39;</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;权重&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;描述&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">group</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SLAGroup</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 查询id=1的数据，否则就显示404页面</span>
<span class="n">SLAGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;hadoop&#39;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;15&#39;</span><span class="p">)</span>  <span class="c1"># 获取或创建</span>
</pre></div>


<h3>1.4 Model性能相关操作：select_related、prefetch_related</h3>
<p><strong>1、普通查询的缺点</strong></p>
<p>1. 例：现在有两张表user,和group两张表，在user表中使用m作为ForeignKey与group表进行一对多关联</p>
<p>2. 如果通过user表中的实例查找对应的group表中的数据，就必须重复发<em>sql请求</em></p>
<p>3. prefetch_related()和select_related()的设计目，都是为了减少SQL查询的数量，但是实现的方式不一样 </p>
<p><strong>2、select_related作用</strong></p>
<p>1. select_related主要针一对一和多对一关系进行优化。</p>
<p>2. select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。</p>
<p><strong>3、prefetch_related()作用</strong></p>
<p>1. prefetch_related()主要对于多对多字段和一对多字段进行优化</p>
<p>2. 进行两次sql查询，将查询结果拼接成一张表<em>放到内存中，再查询就不用发sql请求</em></p>
<p><strong>4、select_related与prefetch_related 使用原则</strong></p>
<p>1. prefetch_related()和select_related()的设计目的很相似，都是为了减少SQL查询的数量，但是实现的方式不一样</p>
<p>2. 因为select_related()总是在单次SQL查询中解决问题，而prefetch_related()会对每个相关表进行SQL查询，因此select_related()的效率高</p>
<p>3. 所以尽可能的用select_related()解决问题。只有在select_related()不能解决问题的时候再去想prefetch_related()。</p>
<p><strong>5、select_related举例说明</strong></p>
<p><strong>作用：</strong>使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化</p>
<div class="highlight"><pre><span></span><span class="c1">#select_related举例说明</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">#1 这种方法低效</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>    <span class="c1">#拿到的仅仅是user表中内容</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">ut_id</span><span class="p">)</span>        <span class="c1">#这里打印user表中的内容不必再次sql请求</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ut</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>               <span class="c1">#第一次查表，没有拿到关联表ut字段中的内容</span>
                                         <span class="c1">#所以每次循环都会再次发sql请求，拿到ut.name的值，低效</span>

    <span class="c1">#2 使用这种方法也仅需要一次数据库查询（拿到的是字典），但是如果查找的不在那些字段中直接报错</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;pwd&#39;</span><span class="p">,</span><span class="s1">&#39;ut__name&#39;</span><span class="p">)</span>

    <span class="c1">#3 select_related()可以一次sql查询拿到所有关联表信息</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span>

    <span class="c1"># 这里还支持指定只拿到那个关联表的所有信息，比如：有多个外键关联，只拿到与ut外键关联的表</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">)</span>


<span class="c1"># select_related() 接受depth参数，depth参数可以确定select_related的深度。</span>
<span class="c1"># Django会递归遍历指定深度内的所有的OneToOneField和ForeignKey。以本例说明：</span>
<span class="c1"># zhangs = Person.objects.select_related(depth = d)</span>
<span class="c1"># d=1  相当于 select_related(‘hometown’,&#39;living’)</span>
<span class="c1"># d=2  相当于 select_related(‘hometown__province’,&#39;living__province’)</span>
</pre></div>


<p><strong>6、prefetch_related举例说明</strong></p>
<p><strong>作用：</strong>进行两次sql查询，将查询结果拼接成一张表</p>
<div class="highlight"><pre><span></span><span class="c1">#prefetch_related:</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__gt</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">)</span>
                       <span class="c1">#ut和tu是user表的两个foreign key，分别关联不同的表</span>

    <span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__gt</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">,</span><span class="s1">&#39;tu&#39;</span><span class="p">)</span>
    <span class="c1">#1 先执行第一次sql查询：select * from users where id &gt; 30;</span>
    <span class="c1">#2 比如：第一次查询结果，获取上一步骤中所有ut_id=[1,2]</span>
    <span class="c1">#3 然后执行第二次sql查询：select * from user_type where id in [1,2]</span>
    <span class="c1">#4 这样就仅执行了两次sql查询将两个表的数据拼到一起，放到内存中，再查询就不用发sql请求</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">ut_id</span><span class="p">)</span>       <span class="c1">#这里打印user表中的内容不必再次sql请求</span>
</pre></div>


<h3>1.5 aggregate和annotate聚合函数 : 求平均值、最大值、最小值等</h3>
<p><strong>1、aggregate聚合函数</strong></p>
<p><strong>作用：</strong>从数据库中取出一个汇总的集合</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span><span class="p">,</span><span class="n">Avg</span><span class="p">,</span><span class="n">Max</span><span class="p">,</span><span class="n">Sum</span>
<span class="k">def</span> <span class="nf">orm</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

    <span class="n">stus</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">stu_num</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">),</span>     <span class="c1">#计算学生表中有多少条age条目</span>
        <span class="n">stu_avg</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">),</span>       <span class="c1">#计算学生的平均年纪</span>
        <span class="n">stu_max</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">),</span>       <span class="c1">#找到年纪最大的学生</span>
        <span class="n">stu_sum</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">))</span>       <span class="c1">#将表中的所有年纪相加</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;stu&#39;</span><span class="p">,</span><span class="n">stus</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
<span class="c1">#运行结果：{&#39;stu_sum&#39;: 69, &#39;stu_max&#39;: 24, &#39;stu_avg&#39;: 23.0, &#39;stu_num&#39;: 3}</span>
</pre></div>


<p><strong>2、annotate实现聚合group by查询</strong></p>
<p><strong>作用：</strong>对查询结果进行分组，比如分组求出各年龄段的人数</p>
<p><strong>注：</strong>    annotate后面加filter过滤相当于原生sql语句中的having</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Sum</span>
<span class="k">def</span> <span class="nf">orm</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">#1 按年纪分组查找学生表中各个年龄段学生人数：（22岁两人，24岁一人）</span>
    <span class="c1"># 查询结果：[{&#39;stu_num&#39;: 2, &#39;age&#39;: 22}, {&#39;stu_num&#39;: 1, &#39;age&#39;: 24}]</span>

    <span class="n">stus1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">stu_num</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">))</span>

    <span class="c1">#2 按年纪分组查找学生表中各个年龄段学生人数，并过滤出年纪大于22的：</span>
    <span class="c1"># 查询结果：[{&#39;stu_num&#39;: 1, &#39;age&#39;: 24}] （年级大于22岁的仅一人，年级为24岁）</span>

    <span class="n">stus2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">stu_num</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">age__gt</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>

    <span class="c1">#3 先按年纪分组，然后查询出各个年龄段学生的平均成绩</span>
    <span class="c1"># 查询结果：[{&#39;stu_Avg&#39;: 86.5, &#39;age&#39;: 22}, {&#39;stu_Avg&#39;: 99.0, &#39;age&#39;: 24}]</span>
    <span class="c1"># 22岁平均成绩：86.5      24岁平均成绩：99</span>

    <span class="n">stus3</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Student</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">stu_Avg</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</pre></div>


<p><strong>3、aggregate<strong><em>*和</em></strong>*annotate</strong><strong>区别</strong></p>
<p>1． Aggregate作用是从数据库取出一个汇总的数据（比如，数量，最大，最小，平均等）</p>
<p>2.   而annotate是先按照设定的条件对数据进行分组，然后根据不同组分别对数据进行汇总</p>
<h3>1.6 Trunc函数处理日期格式数据</h3>
<p><strong>1、Trunc函数作用 及 参数说明</strong></p>
<p><strong>1、作用：</strong>Trunk可以将时间处理成，只有年，或月或日等格式，那些不关心的部分都会变成0</p>
<p><strong>2、Trunk函数可以传入下面四个参数：</strong></p>
<p>a、expression ：传入数据库表中对应要处理的时间那个字段名字</p>
<p>b、kind ：是时间格式的一部分，可以是 year，month，day，hour，minute，second   ，kind指定最后处理后的时间精确到哪一个部分</p>
<p>c、output_field ：只能是这三个格式：DateTimeField(), TimeField(), or DateField()</p>
<p>最后返回的是datetime，date，或则time 就取决于 output_field 字段是如何指定的</p>
<p>d、tzinfosubclass：通常由pytz提供,可以传递给截断值指定一个特定的时区。</p>
<p><strong>3、如果给出的时间是 datetime 2015-06-15 14:30:50.000321+00:00, 使用下面六种 kinds 最后返回结果如下</strong></p>
<p>“year”: 2015-01-01 00:00:00+00:00</p>
<p>“month”: 2015-06-01 00:00:00+00:00</p>
<p>“day”: 2015-06-15 00:00:00+00:00</p>
<p>“hour”: 2015-06-15 14:00:00+00:00</p>
<p>“minute”: 2015-06-15 14:30:00+00:00</p>
<p>“second”: 2015-06-15 14:30:50+00:00</p>
<p><strong>2、解决时差配置问题的报错</strong> </p>
<p>1. 错误：Are time zone definitions for your database and pytz installed?</p>
<p>2. 解决方法：安装pytz模块，在Django settings中配置数据库的时区：  pip3 install pytz</p>
<div class="highlight"><pre><span></span><span class="c1"># 注释的是数据库默认的配置</span>
<span class="c1"># LANGUAGE_CODE = &#39;en-us&#39;</span>
<span class="c1"># TIME_ZONE = &#39;UTC&#39;</span>
<span class="c1"># USE_TZ = True</span>

<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">&#39;zh-Hans&#39;</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">&#39;Asia/Chongqing&#39;</span>
</pre></div>


<p><strong>3、Trunk函数基本使用</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Experiment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">DateTimeField</span>
<span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">Trunc</span>

<span class="k">def</span> <span class="nf">orm</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1">#1 首先向Experiment表中插入三条数据</span>
    <span class="n">Experiment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">321</span><span class="p">))</span>
    <span class="n">Experiment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">123</span><span class="p">))</span>
    <span class="n">Experiment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">999</span><span class="p">))</span>

    <span class="c1">#2 使用Trunk过滤出start_datetime字段，仅保存到日，后面的时分秒全部变成0</span>
    <span class="c1">#3 annotate(experiments=Count(&#39;id&#39;))可以根据天进行分组</span>

    <span class="n">experiments_per_day</span> <span class="o">=</span> <span class="n">Experiment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
         <span class="n">start_day</span><span class="o">=</span><span class="n">Trunc</span><span class="p">(</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">DateTimeField</span><span class="p">())</span>
         <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;start_day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">experiments</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">experiments_per_day</span><span class="p">:</span>
       <span class="k">print</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;start_day&#39;</span><span class="p">],</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;experiments&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;orm&#39;</span><span class="p">)</span>
<span class="c1"># 运行结果：</span>
<span class="c1"># 2015-06-15 00:00:00+00:00  2</span>
<span class="c1"># 2015-12-25 00:00:00+00:00  1</span>
<span class="c1"># 从运行结果中可以看出，2015-06-15日有两条记录，2015-12-25日有1条记录</span>
</pre></div>


<p><strong>4、Trunk函数应用：查询当天签到同学的id</strong></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">attendance</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;签到页面&quot;&quot;&quot;</span>
    <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">current_datetime</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">current_datetime</span><span class="o">.</span><span class="n">month</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">current_datetime</span><span class="o">.</span><span class="n">day</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">course_id</span><span class="p">:</span>
            <span class="c1"># 获取当天已签到的记录</span>
            <span class="n">attended_students</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Attendance</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">attend_day</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">Trunc</span><span class="p">(</span><span class="s1">&#39;attend_time&#39;</span><span class="p">,</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="n">output_field</span><span class="o">=</span><span class="n">DateTimeField</span><span class="p">(),</span> <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">attend_day</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">),</span> <span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;student_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1">#Trunc函数的作用是将&#39;attend_time&#39;中的时间过滤成“day”: 2015-06-15 00:00:00+00:00 这种格式</span>

            <span class="n">tt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>      <span class="c1">#运行结果：2016-03-12 00:00:00</span>

<span class="c1"># 运行结果：  &lt;QuerySet [1, 2]&gt;    #这里的1,2 是数字表示当天只有id=1,和2的学生签到</span>


<span class="c1"># 注：使用这个查询语法和上面的查询结果完全一样</span>
<span class="n">attended_students</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Attendance</span><span class="o">.</span><span class="n">objects</span>\
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">attend_time__date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">),</span><span class="n">course_id</span><span class="o">=</span><span class="n">course_id</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;student_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div></div>
	</div>
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; 韩敏</p>
		</footer>
	  </div>

	</div>
</body>
</html>